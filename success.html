<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ½ï¸ Ù…Ø§ÛŒØ±Ø§ | Ø±Ú˜ÛŒÙ… Ø´Ù…Ø§ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª</title>
  <style>
    body { font-family: Tahoma, sans-serif; text-align: right; direction: rtl; padding: 20px; background: #f8f9fa; color: #333; }
    .btn { background: #28a745; color: white; padding: 14px; border: none; border-radius: 8px; font-size: 16px; width: 100%; margin: 20px 0; }
    h1 { color: #2c3e50; }
    .loader { margin: 20px 0; font-size: 14px; color: #666; }
  </style>
</head>
<body>
  <h1>âœ… Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯</h1>
  <p>Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ„ÛŒØ¯ Ø±Ú˜ÛŒÙ… ØºØ°Ø§ÛŒÛŒ Ø´Ø®ØµÛŒâ€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡â€¦</p>
  <div class="loader">Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯â€¦</div>
  <button class="btn" id="downloadBtn" disabled>Ø¯Ø±ÛŒØ§ÙØª Ø±Ú˜ÛŒÙ… (PDF)</button>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const userData = {
      name: urlParams.get('name') || 'Ú©Ø§Ø±Ø¨Ø±',
      age: urlParams.get('age'),
      weight: urlParams.get('weight'),
      height: urlParams.get('height'),
      gender: urlParams.get('gender'),
      mizaj: urlParams.get('mizaj'),
      blood_type: urlParams.get('blood_type'),
      goal: urlParams.get('goal'),
      duration_weeks: urlParams.get('duration_weeks'),
      activity: urlParams.get('activity'),
      lactose_intolerance: urlParams.get('lactose_intolerance') === 'true',
      gluten_free: urlParams.get('gluten_free') === 'true',
      conditions: (urlParams.get('conditions') || '').split(',').filter(c => c)
    };

    setTimeout(() => {
      document.querySelector('.loader').textContent = 'Ø±Ú˜ÛŒÙ… Ø´Ù…Ø§ Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯!';
      document.getElementById('downloadBtn').disabled = false;
      document.getElementById('downloadBtn').onclick = downloadPlan;
    }, 3000);

    function downloadPlan() {
      // âš ï¸ Ø¬Ø§ÛŒ myra-api Ø¨Ø§ Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡ Ø®ÙˆØ¯Øª Ø¯Ø± Vercel Ø¹ÙˆØ¶ Ú©Ù†
      fetch('https://myra-api.vercel.app/api/generate-plan', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(userData)
      })
      .then(response => {
        if (response.ok) return response.blob();
        throw new Error('Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ Ø±Ú˜ÛŒÙ…');
      })
      .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Ø±Ú˜ÛŒÙ…_ØºØ°Ø§ÛŒÛŒ_${userData.name}.pdf`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      })
      .catch(err => {
        alert('Ø®Ø·Ø§: ' + err.message);
      });
    }
  </script>
</body>
</html>